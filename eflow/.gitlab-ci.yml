stages:
  - test
  - upload
  - notify

variables:
  PYTHONPATH: "."
  PIP_ROOT_USER_ACTION: "ignore"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  
  ALLURE_ENDPOINT: "https://testops.astrazenecacloud.ru"
  ALLURE_PROJECT_ID: "5"
  
  BASE_URL: "https://dev-eflow.astrazenecacloud.ru"
  API_PREFIX: "/gateway/api/v1"

before_script:
  - python -V
  - pip install --upgrade pip
  - pip install --no-cache-dir -r requirements.txt
  - pip install --no-cache-dir allure-pytest

test_eflow_service:
  stage: test
  image: python:3.12
  script:
    - echo "–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ Eflow (mock/smart-mock —Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
    - pytest tests/ -v --alluredir=build/allure-results --junitxml=report.xml || true
    - |
      if [ ! -d "build/allure-results" ] || [ -z "$(ls -A build/allure-results)" ]; then
        echo "‚ùå Allure-–æ—Ç—á—ë—Ç—ã –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã: build/allure-results –ø—É—Å—Ç"
        exit 1
      fi
  allow_failure: true
  artifacts:
    when: always
    reports:
      junit: report.xml
    paths:
      - report.xml
      - build/allure-results/
    expire_in: 1 week
  tags:
    - apps
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: always

test_eflow_integration:
  stage: test
  image: python:3.12
  script:
    - echo "–ó–∞–ø—É—Å–∫ INTEGRATION –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ Eflow (—Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥)"
    - pytest -m integration tests/ -v --alluredir=build/allure-results-integration --junitxml=report-integration.xml || true
    - |
      if [ ! -d "build/allure-results-integration" ] || [ -z "$(ls -A build/allure-results-integration)" ]; then
        echo "‚ùå Allure-–æ—Ç—á—ë—Ç—ã –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã: build/allure-results-integration –ø—É—Å—Ç"
        exit 1
      fi
  allow_failure: true
  artifacts:
    when: always
    reports:
      junit: report-integration.xml
    paths:
      - report-integration.xml
      - build/allure-results-integration/
    expire_in: 1 week
  tags:
    - apps
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always  
    - when: never

upload_allure_report:
  stage: upload
  image: alpine:latest
  before_script:
    - apk add --no-cache curl ca-certificates
  script:
    - curl -fsSL https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64 -o allurectl
    - chmod +x allurectl
    - ./allurectl upload --project-id "$ALLURE_PROJECT_ID" --endpoint "$ALLURE_ENDPOINT" --insecure build/allure-results
  tags:
    - apps
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

notify_fail:
  stage: notify
  image: alpine:latest
  script:
    - if [ -f ci-notify.sh ]; then chmod +x ci-notify.sh && ./ci-notify.sh "üò® –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω! üî•"; fi
  when: on_failure
  tags:
    - apps
